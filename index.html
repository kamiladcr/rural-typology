<!doctype html>
<html data-theme="light">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>GRANULAR - Rural typology</title>
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <style>
     body {
       width: 100%;
       height: 100%;
       margin: 0;
       padding: 0;
     }
     html {
       height: 100%;
     }
     #map {
       width: 100%;
       height: 100%;
     }
     .maplibregl-popup-content {
       font-family: 'Montserrat', sans-serif;
       font-size: 12px;
       background-color: #f4c01e !important;
       color: white !important;
     }
     .maplibregl-popup-close-button {
       color: white;
     }

     /* Control panel styles */
     .control-panel {
       position: absolute;
       top: 10px;
       right: 10px;
       background: white;
       padding: 15px;
       border-radius: 8px;
       box-shadow: 0 2px 10px rgba(0,0,0,0.1);
       font-family: 'Montserrat', sans-serif;
       z-index: 1;
       min-width: 220px;
       max-height: 90vh;
       overflow-y: auto;
     }

     .control-panel .logo {
       width: 100%;
       max-width: 200px;
       margin-top: 10px;
       margin-bottom: 30px;
       display: block;
     }

     .control-panel h3 {
       margin: 0 0 10px 0;
       font-size: 14px;
       font-weight: 600;
       color: #333;
     }

     .control-group {
       margin-bottom: 15px;
       padding-bottom: 15px;
       border-bottom: 1px solid #eee;
     }

     .control-group:last-child {
       border-bottom: none;
       padding-bottom: 0;
     }

     .control-group label {
       display: block;
       font-size: 12px;
       color: #666;
       margin-bottom: 5px;
     }

     .control-group input[type="range"] {
       width: 100%;
       cursor: pointer;
       -webkit-appearance: none;
       appearance: none;
       height: 6px;
       background: #ddd;
       border-radius: 3px;
       outline: none;
     }

     .control-group input[type="range"]::-webkit-slider-thumb {
       -webkit-appearance: none;
       appearance: none;
       width: 18px;
       height: 18px;
       background: #f4c01e;
       border-radius: 50%;
       cursor: pointer;
       border: 2px solid white;
       box-shadow: 0 2px 4px rgba(0,0,0,0.2);
     }

     .control-group input[type="range"]::-moz-range-thumb {
       width: 18px;
       height: 18px;
       background: #f4c01e;
       border-radius: 50%;
       cursor: pointer;
       border: 2px solid white;
       box-shadow: 0 2px 4px rgba(0,0,0,0.2);
     }

     .control-group .value-display {
       display: inline-block;
       font-size: 12px;
       color: #333;
       font-weight: 600;
       margin-left: 5px;
     }

     /* Group toggle styles */
     .group-toggle {
       margin-bottom: 10px;
       padding: 8px;
       background-color: #f9f9f9;
       border-radius: 4px;
     }

     .group-toggle-header {
       display: flex;
       align-items: center;
       margin-bottom: 8px;
       font-weight: 600;
       font-size: 12px;
       color: #333;
     }

     .group-toggle-header input[type="checkbox"] {
       margin-right: 8px;
       cursor: pointer;
       width: 16px;
       height: 16px;
     }

     .group-classes {
       padding-left: 24px;
     }

     /* Class toggle styles */
     .class-toggle {
       display: flex;
       align-items: center;
       margin-bottom: 6px;
       padding: 4px;
       border-radius: 4px;
       transition: background-color 0.2s;
     }

     .class-toggle:hover {
       background-color: #f5f5f5;
     }

     .class-toggle input[type="checkbox"] {
       margin-right: 8px;
       cursor: pointer;
       width: 14px;
       height: 14px;
     }

     .class-color {
       width: 14px;
       height: 14px;
       border-radius: 3px;
       margin-right: 8px;
       border: 1px solid rgba(0,0,0,0.1);
     }

     .class-label {
       font-size: 11px;
       color: #555;
       flex: 1;
     }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="control-panel">
      <img src="img/logo-granular-2x.svg" class="logo">

      <div class="control-group">
        <label>
          Opacity: <span class="value-display" id="opacity-value">100%</span>
        </label>
        <input
          type="range"
          id="opacity-slider"
          min="0"
          max="100"
          value="100"
        />
      </div>

      <div class="control-group">
        <label>Visible Classes</label>

        <!-- DEGURBA 11 Group -->
        <div class="group-toggle">
          <div class="group-toggle-header">
            <input type="checkbox" id="group-degurba-11" checked>
            <span>DEGURBA 11</span>
          </div>
          <div class="group-classes">
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_11_class_0" value="degurba_11_class_0" checked>
              <div class="class-color" style="background-color: #683e0c;"></div>
              <span class="class-label">Class 0</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_11_class_1" value="degurba_11_class_1" checked>
              <div class="class-color" style="background-color: #a56d34;"></div>
              <span class="class-label">Class 1</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_11_class_2" value="degurba_11_class_2" checked>
              <div class="class-color" style="background-color: #cba67c;"></div>
              <span class="class-label">Class 2</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_11_class_3" value="degurba_11_class_3" checked>
              <div class="class-color" style="background-color: #ddc4ab;"></div>
              <span class="class-label">Class 3</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_11_class_4" value="degurba_11_class_4" checked>
              <div class="class-color" style="background-color: #c2d8aa;"></div>
              <span class="class-label">Class 4</span>
            </div>
          </div>
        </div>

        <!-- DEGURBA 12 Group -->
        <div class="group-toggle">
          <div class="group-toggle-header">
            <input type="checkbox" id="group-degurba-12" checked>
            <span>DEGURBA 12</span>
          </div>
          <div class="group-classes">
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_12_class_0" value="degurba_12_class_0" checked>
              <div class="class-color" style="background-color: #a3bf7c;"></div>
              <span class="class-label">Class 0</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_12_class_1" value="degurba_12_class_1" checked>
              <div class="class-color" style="background-color: #698f5c;"></div>
              <span class="class-label">Class 1</span>
            </div>
          </div>
        </div>

        <!-- DEGURBA 13 Group -->
        <div class="group-toggle">
          <div class="group-toggle-header">
            <input type="checkbox" id="group-degurba-13" checked>
            <span>DEGURBA 13</span>
          </div>
          <div class="group-classes">
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_13_class_0" value="degurba_13_class_0" checked>
              <div class="class-color" style="background-color: #4a7c59;"></div>
              <span class="class-label">Class 0</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_13_class_1" value="degurba_13_class_1" checked>
              <div class="class-color" style="background-color: #2d5a3d;"></div>
              <span class="class-label">Class 1</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
     // Register PMTiles protocol
     let protocol = new pmtiles.Protocol();
     maplibregl.addProtocol("pmtiles", protocol.tile);

     const map = new maplibregl.Map({
       container: 'map',
       style: "https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",
       center: [1.4, 49.4],
       zoom: 5,
       minZoom: 0,
       maxZoom: 14,
     });

     // Add navigation controls
     map.addControl(new maplibregl.NavigationControl(), 'top-left');

     map.on('load', () => {
       // PMTiles source
       map.addSource('polygons', {
         type: 'vector',
         url: 'pmtiles://layers/polygons.pmtiles',
       });

       // Add fill layer with color based on cluster_info
       map.addLayer({
         id: 'polygons-fill',
         type: 'fill',
         source: 'polygons',
         'source-layer': 'polygons',
         paint: {
           'fill-color': [
             'match',
             ['get', 'cluster_info'],
             'degurba_11_class_0', '#683e0c',
             'degurba_11_class_1', '#a56d34',
             'degurba_11_class_2', '#cba67c',
             'degurba_11_class_3', '#ddc4ab',
             'degurba_11_class_4', '#c2d8aa',
             'degurba_12_class_0', '#a3bf7c',
             'degurba_12_class_1', '#698f5c',
             'degurba_13_class_0', '#4a7c59',
             'degurba_13_class_1', '#2d5a3d',
             '#a09fbc' // default
           ],
           'fill-opacity': 1
         }
       });

       // Add line layer for borders
       map.addLayer({
         id: 'polygons-line',
         type: 'line',
         source: 'polygons',
         'source-layer': 'polygons',
         paint: {
           'line-color': '#ffffff',
           'line-width': 0.3,
           'line-opacity': 0.3
         }
       });

       // Opacity slider control
       const opacitySlider = document.getElementById('opacity-slider');
       const opacityValue = document.getElementById('opacity-value');

       opacitySlider.addEventListener('input', (e) => {
         const opacity = e.target.value / 100;
         opacityValue.textContent = e.target.value + '%';
         map.setPaintProperty('polygons-fill', 'fill-opacity', opacity);
       });

       // Class visibility management
       const visibleClasses = new Set([
         'degurba_11_class_0', 'degurba_11_class_1', 'degurba_11_class_2', 'degurba_11_class_3', 'degurba_11_class_4',
         'degurba_12_class_0', 'degurba_12_class_1',
         'degurba_13_class_0', 'degurba_13_class_1'
       ]);

       const groupClasses = {
         'degurba-11': ['degurba_11_class_0', 'degurba_11_class_1', 'degurba_11_class_2', 'degurba_11_class_3', 'degurba_11_class_4'],
         'degurba-12': ['degurba_12_class_0', 'degurba_12_class_1'],
         'degurba-13': ['degurba_13_class_0', 'degurba_13_class_1']
       };

       function updateFilter() {
         if (visibleClasses.size === 0) {
           map.setLayoutProperty('polygons-fill', 'visibility', 'none');
           map.setLayoutProperty('polygons-line', 'visibility', 'none');
         } else {
           map.setLayoutProperty('polygons-fill', 'visibility', 'visible');
           map.setLayoutProperty('polygons-line', 'visibility', 'visible');

           const filter = ['in', ['get', 'cluster_info'], ['literal', Array.from(visibleClasses)]];
           map.setFilter('polygons-fill', filter);
           map.setFilter('polygons-line', filter);
         }
       }

       // Individual class checkboxes
       const allClassCheckboxes = document.querySelectorAll('.class-toggle input[type="checkbox"]');
       allClassCheckboxes.forEach(checkbox => {
         checkbox.addEventListener('change', (e) => {
           const classValue = e.target.value;

           if (e.target.checked) {
             visibleClasses.add(classValue);
           } else {
             visibleClasses.delete(classValue);
           }

           // Update group checkbox state
           const group = classValue.split('_')[0] + '-' + classValue.split('_')[1];
           updateGroupCheckbox(group);

           updateFilter();
         });
       });

       // Group checkboxes
       Object.keys(groupClasses).forEach(groupId => {
         const groupCheckbox = document.getElementById(`group-${groupId}`);

         groupCheckbox.addEventListener('change', (e) => {
           const classes = groupClasses[groupId];

           classes.forEach(className => {
             const classCheckbox = document.getElementById(`class-${className}`);
             classCheckbox.checked = e.target.checked;

             if (e.target.checked) {
               visibleClasses.add(className);
             } else {
               visibleClasses.delete(className);
             }
           });

           updateFilter();
         });
       });

       function updateGroupCheckbox(groupId) {
         const groupCheckbox = document.getElementById(`group-${groupId}`);
         const classes = groupClasses[groupId];

         const allChecked = classes.every(cls => visibleClasses.has(cls));
         const someChecked = classes.some(cls => visibleClasses.has(cls));

         groupCheckbox.checked = allChecked;
         groupCheckbox.indeterminate = someChecked && !allChecked;
       }

       // Add popup on click
       map.on('click', 'polygons-fill', (e) => {
         const props = e.features[0].properties;

         new maplibregl.Popup()
                       .setLngLat(e.lngLat)
                       .setHTML(`
             <div>
               <b>${props.cluster_info}</b><br/>
               <small>ID: ${props.GRD_ID}</small>
             </div>
                       `)
                       .addTo(map);
       });

       // Change cursor on hover
       map.on('mouseenter', 'polygons-fill', () => {
         map.getCanvas().style.cursor = 'pointer';
       });

       map.on('mouseleave', 'polygons-fill', () => {
         map.getCanvas().style.cursor = '';
       });
     });
    </script>
  </body>
</html>
