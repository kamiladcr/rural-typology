<!doctype html>
<html data-theme="light">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>GRANULAR - Rural typology</title>
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <style>
     body {
       width: 100%;
       height: 100%;
       margin: 0;
       padding: 0;
     }
     html {
       height: 100%;
     }
     #map {
       width: 100%;
       height: 100%;
     }
     .maplibregl-popup-content {
       font-family: 'Montserrat', sans-serif;
       font-size: 12px;
       background-color: #f4c01e !important;
       color: white !important;
     }
     .maplibregl-popup-close-button {
       color: white;
     }


     /* Control panel styles */
     .control-panel {
       position: absolute;
       top: 10px;
       right: 10px;
       background: white;
       padding: 15px;
       border-radius: 8px;
       box-shadow: 0 2px 10px rgba(0,0,0,0.1);
       font-family: 'Montserrat', sans-serif;
       z-index: 1;
       min-width: 200px;
     }

     .control-panel .logo {
       width: 100%;
       max-width: 200px;
       margin-top: 10px;
       margin-bottom: 30px;
       display: block;
     }

     .control-panel h3 {
       margin: 0 0 10px 0;
       font-size: 14px;
       font-weight: 600;
       color: #333;
     }

     .control-group {
       margin-bottom: 10px;
     }

     .control-group label {
       display: block;
       font-size: 12px;
       color: #666;
       margin-bottom: 5px;
     }

     .control-group input[type="range"] {
       width: 100%;
       cursor: pointer;
     }

     .control-group .value-display {
       display: inline-block;
       font-size: 12px;
       color: #333;
       font-weight: 600;
       margin-left: 5px;
     }


     /* Slider track styling */
     .control-group input[type="range"] {
       width: 100%;
       cursor: pointer;
       -webkit-appearance: none;
       appearance: none;
       height: 6px;
       background: #ddd;
       border-radius: 3px;
       outline: none;
     }

     .control-group input[type="range"]::-webkit-slider-thumb {
       -webkit-appearance: none;
       appearance: none;
       width: 18px;
       height: 18px;
       background: #f4c01e;
       border-radius: 50%;
       cursor: pointer;
       border: 2px solid white;
       box-shadow: 0 2px 4px rgba(0,0,0,0.2);
     }

     .control-group input[type="range"]::-moz-range-thumb {
       width: 18px;
       height: 18px;
       background: #f4c01e;  /* Your yellow color */
       border-radius: 50%;
       cursor: pointer;
       border: 2px solid white;
       box-shadow: 0 2px 4px rgba(0,0,0,0.2);
     }


     /* Class toggle styles */
     .class-toggle {
       display: flex;
       align-items: center;
       margin-bottom: 8px;
       padding: 4px;
       border-radius: 4px;
       transition: background-color 0.2s;
     }

     .class-toggle:hover {
       background-color: #f5f5f5;
     }

     .class-toggle input[type="checkbox"] {
       margin-right: 8px;
       cursor: pointer;
       width: 16px;
       height: 16px;
     }

     .class-color {
       width: 16px;
       height: 16px;
       border-radius: 3px;
       margin-right: 8px;
       border: 1px solid rgba(0,0,0,0.1);
     }

     .class-label {
       font-size: 11px;
       color: #333;
       flex: 1;
     }


    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="control-panel">

      <img src="img/logo-granular-2x.svg" class="logo">

      <!-- <h3>Map Controls</h3>
      -->

      <div class="control-group">
        <label>
          Opacity: <span class="value-display" id="opacity-value">100%</span>
        </label>
        <input
          type="range"
          id="opacity-slider"
          min="0"
          max="100"
          value="100"
        />
      </div>


      <div class="control-group">
        <label>Visible Classes</label>

        <div class="class-toggle">
          <input type="checkbox" id="class-1" value="1" checked>
          <div class="class-color" style="background-color: #683e0c;"></div>
          <span class="class-label">Class 1</span>
        </div>

        <div class="class-toggle">
          <input type="checkbox" id="class-2" value="2" checked>
          <div class="class-color" style="background-color: #a56d34;"></div>
          <span class="class-label">Class 2</span>
        </div>

        <div class="class-toggle">
          <input type="checkbox" id="class-3" value="3" checked>
          <div class="class-color" style="background-color: #cba67c;"></div>
          <span class="class-label">Class 3</span>
        </div>

        <div class="class-toggle">
          <input type="checkbox" id="class-4" value="4" checked>
          <div class="class-color" style="background-color: #ddc4ab;"></div>
          <span class="class-label">Class 4</span>
        </div>

        <div class="class-toggle">
          <input type="checkbox" id="class-5" value="5" checked>
          <div class="class-color" style="background-color: #c2d8aa;"></div>
          <span class="class-label">Class 5</span>
        </div>
      </div>


    </div>

    <script>
     // Register PMTiles protocol
     let protocol = new pmtiles.Protocol();
     maplibregl.addProtocol("pmtiles", protocol.tile);

     const map = new maplibregl.Map({
       container: 'map',
       /* style: "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json", */
       style: "https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",
       center: [1.4, 49.4],
       zoom: 5,
       minZoom: 0,
       maxZoom: 14,
     });

     // Add navigation controls
     map.addControl(new maplibregl.NavigationControl(), 'top-left');

     map.on('load', () => {
       // PMTiles source
       map.addSource('polygons', {
         type: 'vector',
         url: 'pmtiles://layers/polygons.pmtiles',
       });

       // Add fill layer with color based on urbanization_rank
       map.addLayer({
         id: 'polygons-fill',
         type: 'fill',
         source: 'polygons',
         'source-layer': 'polygons',
         paint: {
           'fill-color': [
             'match',
             ['get', 'urbanization_rank'],
             1, '#683e0c',
             2, '#a56d34',
             3, '#cba67c',
             4, '#ddc4ab',
             5, '#c2d8aa',
             '#a09fbc'
           ],
           'fill-opacity': 1
         }
       });

       // Add line layer for borders
       map.addLayer({
         id: 'polygons-line',
         type: 'line',
         source: 'polygons',
         'source-layer': 'polygons',
         paint: {
           'line-color': '#ffffff',
           'line-width': 0.3,
           'line-opacity': 0.3
         }
       });

       // Opacity slider control
       const opacitySlider = document.getElementById('opacity-slider');
       const opacityValue = document.getElementById('opacity-value');

       opacitySlider.addEventListener('input', (e) => {
         const opacity = e.target.value / 100;
         opacityValue.textContent = e.target.value + '%';

         map.setPaintProperty('polygons-fill', 'fill-opacity', opacity);
       });


       // Add popup on click
       map.on('click', 'polygons-fill', (e) => {
         const props = e.features[0].properties;
         const typeNames = {
           1: "1",
           2: "2",
           3: "3",
           4: "4",
           5: "5",
         };

         new maplibregl.Popup()
                       .setLngLat(e.lngLat)
                       .setHTML(`
             <div>
               <b>Cluster: ${typeNames[props.urbanization_rank] || 'Unknown'}</b><br/>
               <small>ID: ${props.GRD_ID}</small>
             </div>
                       `)
                       .addTo(map);
       });

       // Change cursor on hover
       map.on('mouseenter', 'polygons-fill', () => {
         map.getCanvas().style.cursor = 'pointer';
       });

       map.on('mouseleave', 'polygons-fill', () => {
         map.getCanvas().style.cursor = '';
       });
     });


     // Class visibility toggles
     const visibleClasses = new Set([1, 2, 3, 4, 5]);

     function updateFilter() {
       if (visibleClasses.size === 0) {
         // If nothing selected, hide layer
         map.setLayoutProperty('polygons-fill', 'visibility', 'none');
         map.setLayoutProperty('polygons-line', 'visibility', 'none');
       } else {
         map.setLayoutProperty('polygons-fill', 'visibility', 'visible');
         map.setLayoutProperty('polygons-line', 'visibility', 'visible');

         // Create filter expression
         const filter = ['in', ['get', 'urbanization_rank'], ['literal', Array.from(visibleClasses)]];
         map.setFilter('polygons-fill', filter);
         map.setFilter('polygons-line', filter);
       }
     }

     // Add listeners to all class checkboxes
     for (let i = 1; i <= 5; i++) {
       const checkbox = document.getElementById(`class-${i}`);
       checkbox.addEventListener('change', (e) => {
         const classValue = parseInt(e.target.value);

         if (e.target.checked) {
           visibleClasses.add(classValue);
         } else {
           visibleClasses.delete(classValue);
         }

         updateFilter();
       });
     }


    </script>
  </body>
</html>
